{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-12 text-center mb-5">
        <h1 class="wedding-title">Your Memories Collection</h1>
        <p class="lead">Photos and wishes from your loved ones</p>
    </div>
</div>

<div class="text-center mb-4">
    <div class="progress" style="height: 25px; background-color: var(--old-rose-light);">
        <div class="progress-bar" role="progressbar" 
             style="width: {{ viewed_count|divisibleby:total_count|yesno:'100,0' }}%; background-color: var(--old-rose);" 
             aria-valuenow="{{ viewed_count }}" aria-valuemin="0" aria-valuemax="{{ total_count }}">
            {{ viewed_count }} / {{ total_count }} Photos Viewed
        </div>
    </div>
</div>

<div class="photo-container">
    {% if photos %}
        <div class="row g-4" id="photo-gallery">
            {% for photo in photos %}
                <div class="col-md-4 col-sm-6 photo-item {% if not photo.is_viewed %}new-photo{% endif %}">
                    <div class="card h-100 shadow photo-card" data-id="{{ photo.id }}">
                        <img src="{{ photo.image.url }}" class="card-img-top" alt="Photo by {{ photo.user.first_name }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ photo.user.first_name }} {{ photo.user.last_name }}</h5>
                            {% if photo.message %}
                                <p class="card-text">{{ photo.message }}</p>
                            {% else %}
                                <p class="card-text text-muted">No message</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center my-5">
            <h3>No photos uploaded yet</h3>
            <p>When your guests start uploading photos, they will appear here.</p>
        </div>
    {% endif %}
</div>

<div class="heart-container fixed-bottom text-center p-3" style="background-color: rgba(255, 249, 250, 0.9);">
    <div class="row">
        <div class="col-12">
            <div class="heart-progress">
                <svg width="150" height="150" viewBox="0 0 100 100">
                    <path d="M50,30 C35,10 10,10 10,30 C10,60 50,80 50,80 C50,80 90,60 90,30 C90,10 65,10 50,30 Z" 
                        fill="none" stroke="var(--old-rose-light)" stroke-width="3"></path>
                    <path id="heart-fill" d="M50,30 C35,10 10,10 10,30 C10,60 50,80 50,80 C50,80 90,60 90,30 C90,10 65,10 50,30 Z" 
                        fill="var(--old-rose)" stroke="none">
                        <animate attributeName="opacity" from="0" to="1" dur="0.5s" begin="indefinite" fill="freeze" id="heart-animation" />
                    </path>
                </svg>
                <div class="mt-2">
                    <span class="heart-counter">{{ viewed_count }} / {{ total_count }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .photo-container {
        margin-bottom: 220px; /* Space for heart container */
    }
    
    .photo-card {
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
    }
    
    .photo-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
    }
    
    .heart-container {
        z-index: 1000;
    }
    
    .new-photo .card {
        border: 2px solid var(--old-rose);
        position: relative;
    }
    
    .new-photo .card::after {
        content: "New";
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: var(--old-rose);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
    }
    
    #heart-fill {
        opacity: 0;
    }
    
    .photo-modal .modal-content {
        border-color: var(--old-rose-light);
    }
    
    .photo-modal .modal-header, .photo-modal .modal-footer {
        background-color: var(--old-rose-light);
        border-color: var(--old-rose-light);
    }
</style>

<div class="modal fade photo-modal" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalUserName"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid rounded" alt="Photo">
                <div class="mt-4" id="modalMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const photoCards = document.querySelectorAll('.photo-card');
        const heartFill = document.getElementById('heart-fill');
        const heartAnimation = document.getElementById('heart-animation');
        const heartCounter = document.querySelector('.heart-counter');
        const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));
        const modalImage = document.getElementById('modalImage');
        const modalUserName = document.getElementById('modalUserName');
        const modalMessage = document.getElementById('modalMessage');
        
        // Set initial heart fill
        const viewed = {{ viewed_count }};
        const total = {{ total_count }};
        if (total > 0) {
            heartFill.style.opacity = viewed / total;
        }
        
        // Open photo modal and mark as viewed
        photoCards.forEach(card => {
            card.addEventListener('click', function() {
                const photoId = this.dataset.id;
                const photoUrl = this.querySelector('img').src;
                const userName = this.querySelector('.card-title').textContent;
                const message = this.querySelector('.card-text').textContent;
                
                modalImage.src = photoUrl;
                modalUserName.textContent = userName;
                modalMessage.textContent = message === 'No message' ? '' : message;
                
                // Mark photo as viewed via API
                if (this.closest('.photo-item').classList.contains('new-photo')) {
                    fetch(`/api/photos/${photoId}/view`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update UI
                            this.closest('.photo-item').classList.remove('new-photo');
                            
                            // Update heart fill
                            const newViewedCount = parseInt(heartCounter.textContent.split('/')[0].trim()) + 1;
                            const totalCount = parseInt(heartCounter.textContent.split('/')[1].trim());
                            
                            heartCounter.textContent = `${newViewedCount} / ${totalCount}`;
                            
                            // Animate heart fill
                            const newOpacity = newViewedCount / totalCount;
                            heartFill.style.opacity = newOpacity;
                            
                            // Trigger heart animation
                            heartAnimation.beginElement();
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
                
                photoModal.show();
            });
        });
        
        // Get storage info
        fetch('/api/storage')
            .then(response => response.json())
            .then(data => {
                if (data.warning) {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'alert alert-warning mb-4';
                    warningDiv.innerHTML = `
                        <strong>Storage Alert:</strong> 
                        ${Math.round(data.percentage)}% of available storage used 
                        (${Math.round(data.used_bytes/1048576)} MB / ${Math.round(data.total_bytes/1048576)} MB)
                    `;
                    document.querySelector('.photo-container').prepend(warningDiv);
                }
            });
    });
</script>
{% endblock %}